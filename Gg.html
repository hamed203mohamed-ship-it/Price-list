<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø¹Ø±Ø¶ Ø£Ø³Ø¹Ø§Ø± - Ù…Ø¤Ø³Ø³Ø© Ø£Ø­Ø¯Ø« Ø§Ù„Ø´Ø¨ÙƒØ§Øª</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f5f5f5; padding: 10px; }
  
  .client-display { 
      display: none !important; 
  }

  /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨) */
  @media print {
    body { background: white; padding: 0; }
    .no-print { display: none !important; } /* ğŸ› ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙ„Ø§Ø³ ÙŠØ¶Ù…Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡ */
    .container { box-shadow: none; width: 100%; margin: 0; }
    
    .client-display { 
        display: flex !important; 
        flex-wrap: wrap;
        gap: 15px !important;
        margin-bottom: 15px !important;
        padding: 10px; 
        border: 1px solid #ddd; 
        background: #f9f9f9;
        font-size: 15px; 
    } 
    
    .client-display p:empty { 
        display: none !important; 
    }
    
    .header-label { display: none !important; } 
    .client-info-container { flex-direction: column !important; gap: 0 !important; }

    #quoteContainer table { border-collapse: collapse; }
    #quoteContainer table thead tr { border-bottom: 2px solid #2d4663; }
    #quoteContainer table th { padding: 8px 5px; border: none; }
    #table td { padding: 8px 5px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; border-left: none; border-right: none; font-size: 13px; }

    #notesContent { 
      white-space: pre-wrap; 
      line-height: 1.8 !important; 
      padding-right: 15px; 
    }
    
  }
  
  @page { size: A4; margin: 15mm; }
  .container { max-width: 1200px; margin: 0 auto; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
  
  /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
  .controls { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 15px; color: white; }
  .btn:hover { opacity: 0.9; }
  .btn-print { background: #2d4663; }
  .btn-pdf { background: #3b82f6; }
  .btn-add { background: #10b981; }
  .btn-import { background: #f59e0b; }
  .btn-danger { background: #ef4444; }
  .btn-manual-add { background: #9453a6; }

  /* ğŸ› ï¸ ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
  .controls .btn {
    flex: 1 1 45%; /* ÙŠØ³Ù…Ø­ Ù„Ø²Ø±ÙŠÙ† Ø¨Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ */
    min-width: 120px; 
  }
  /* ğŸ› ï¸ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù…ÙˆØ¯ÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
  @media screen and (max-width: 500px) {
    .controls {
      flex-direction: column; 
    }
    .controls .btn {
      flex: 1 1 100%; 
      margin-bottom: 5px; 
    }
  }

  /* Ø±Ø£Ø³ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ */
  .header { background: linear-gradient(135deg, #2d4663, #1e2f45); color: white; padding: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
  .header-details { display: flex; flex-direction: column; flex: 1; gap: 5px; }
  .header h1 { font-size: 24px; margin-bottom: 8px; }
  .logo-box { width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; background: #f9fafb; border-radius: 6px; overflow: hidden; }
  .client-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
  .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }

  /* ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ #2: ÙØµÙ„ Ø¬Ù…Ù„Ø© Ø§Ù„Ø´ÙƒØ± Ø¨Ù…Ø³Ø§ÙØ© Ø³ÙÙ„ÙŠØ© ÙÙŠ Ø§Ù„Ù€ Footer */
  .footer { 
    background:#2d4663; 
    color:#fff; 
    padding:15px; 
    text-align:center;
  }
  .footer p:first-child { 
    margin-bottom: 5px; /* ÙŠØ¶ÙŠÙ Ù…Ø³Ø§ÙØ© 5 Ø¨ÙƒØ³Ù„ Ø¨Ø¹Ø¯ Ø¬Ù…Ù„Ø© "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§" */
    line-height: 1.5; /* ÙŠØ¶Ù…Ù† Ù…Ø³Ø§ÙØ© Ø³Ø·Ø± Ø¥Ø¶Ø§ÙÙŠØ© */
  }


  /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡) */
  #productsManagerBox, #clientsManagerBox {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background:white; 
    color: #333; 
    padding:20px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.4); z-index:2000; 
    width: 90%; 
    max-width: 1000px; 
    height: auto;
    max-height: 95vh; 
    overflow-y: auto; 
    display: none;
  }
  #productsManagerBox table, #clientsManagerBox table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
  }
  #productsManagerBox th, #productsManagerBox td, #clientsManagerBox th, #clientsManagerBox td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
  }
  #productsManagerBox td[contenteditable="true"], #clientsManagerBox td[contenteditable="true"] {
      background: #fcfcfc; 
      cursor: text;
  }
  #productsManagerBox tbody tr:hover, #clientsManagerBox tbody tr:hover {
      background: #f5f5f5;
  }
  #productsManagerBox #productSearch, #clientsManagerBox #clientSearch {
    width: 100%; 
    padding: 10px; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
    margin-bottom: 10px;
  }
  
  
  textarea { 
    width: 100%; 
    min-height: 150px; 
    padding: 10px; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
    color: #333; 
  }
  
  /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ */
  .autocomplete-list {
    position: absolute;
    z-index: 100;
    max-height: 150px;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #ccc;
    width: 100%; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    top: 100%; 
  }
  .autocomplete-item {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
  }
  .autocomplete-item:hover {
    background-color: #f0f0f0;
  }
  
  /* Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªØµÙ */
  #addItemBox, #companyInfoForm, #manualItemBox, #importModalBox { 
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%);
    background:white; 
    color: #333; 
    padding:20px; 
    border-radius:8px; 
    box-shadow:0 0 15px rgba(0,0,0,0.4); 
    z-index:2000; 
    width: 90%; 
    max-width: 350px; 
    max-height: 95vh; 
    overflow-y: auto; 
  }

  #addItemBox input, #companyInfoForm input, #manualItemBox input, #manualItemBox textarea, #importModalBox textarea { 
    width: 100%; padding:8px; margin-top:5px; margin-bottom: 10px; border-radius:4px; border:1px solid #ccc; 
    color: #333; 
  }
  
  /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ */
  .company-sub-title { 
      font-size: 16px; 
      color: #f9fafb; 
      margin-top: -5px; 
      margin-bottom: 10px;
  }
  
  /* ğŸ› ï¸ ØªÙ†Ø³ÙŠÙ‚ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· */
  .print-only { display: none; }
  @media print {
      .print-only { display: inline !important; }
  }
</style>
</head>
<body>

<div class="controls no-print">
  <button class="btn btn-print" onclick="printQuote()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  <button class="btn btn-pdf" onclick="savePDF()">ğŸ“‘ Ø­ÙØ¸ PDF</button>
  <button class="btn" style="background:#0a84ff;" onclick="showProductsManager()">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
  <button class="btn" style="background:#00bcd4;" onclick="showClientsManager()">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button> <button class="btn" style="background:#555; margin-left:10px;" onclick="showCompanyInfoForm()">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
</div>

<div id="clientsManagerBox">
    <h3>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙŠÙ†</h3>
    <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: space-between;">
        <input type="text" id="clientSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." oninput="filterClientsTable()" style="flex:1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
        <button class="btn btn-import" onclick="exportClientsToExcel()">ğŸ“Š Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¥Ù„Ù‰ Excel</button>
    </div>

    <div style="max-height: 450px; overflow-y: auto;">
        <table id="clientsTable">
            <thead>
                <tr>
                    <th style="width: 5%;">Ù…</th>
                    <th style="width: 30%;">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th style="width: 40%;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                    <th style="width: 15%;">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                    <th style="width: 10%;">ØªØ­ÙƒÙ…</th>
                </tr>
            </thead>
            <tbody id="clientsTableBody">
            </tbody>
        </table>
    </div>
    <div style="margin-top:20px; text-align: center;">
        <button class="btn btn-danger" onclick="hideClientsManager()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
<div id="importModalBox" style="max-width: 500px;">
  <div class="modal-content" style="max-width: 500px;">
    <h3>ğŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</h3>
    <p>Ø§Ù†Ø³Ø® Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø«Ù„Ø§Ø«Ø© (Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ØŒ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©) ÙˆØ§Ù„ØµÙ‚ Ù‡Ù†Ø§:</p>
    <textarea id="excelData" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ \t ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ \t Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©"></textarea>
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button class="btn btn-add" style="flex:1;" onclick="importData()">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ­ÙØ¸</button>
      <button class="btn btn-danger" onclick="hideImportModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="addItemBox">
  <h3>Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ (Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)</h3>
  <label>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù:</label>
  <input type="text" id="searchItem" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù..." oninput="filterProducts()" />
  <div id="suggestions" style="max-height:150px; overflow:auto; border:1px solid #ccc; padding:5px; margin-top:5px; margin-bottom:10px;"></div>
  <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
  <input type="number" id="itemQty" value="1" min="1" />
  <div style="margin-top:10px; display:flex; gap:10px;">
    <button class="btn btn-add" onclick="addSelectedItem()">Ø¥Ø¶Ø§ÙØ©</button>
    <button class="btn btn-danger" onclick="hideAddItem()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div id="manualItemBox">
  <h3>â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
  <label>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:</label>
  <input type="text" id="manualName" placeholder="Ù…Ø«Ø§Ù„: ØªØ±ÙƒÙŠØ¨ ÙƒØ§Ù…ÙŠØ±Ø§ Hikvision" />
  <label>ÙˆØµÙ Ø§Ù„ØµÙ†Ù:</label>
  <textarea id="manualDesc" placeholder="Ù…Ø«Ø§Ù„: ØªÙˆØ±ÙŠØ¯ ÙˆØªØ±ÙƒÙŠØ¨ ÙƒØ§Ù…ÙŠØ±Ø§ Ø´Ø¨ÙƒÙŠØ© Ø¨Ø¯Ù‚Ø© 4 Ù…ÙŠØ¬Ø§"></textarea>
  <label>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±.Ø³):</label>
  <input type="number" id="manualCost" placeholder="100.00" min="0" step="0.01" />
  <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
  <input type="number" id="manualQty" value="1" min="1" />
  <div style="margin-top:10px; display:flex; gap:10px;">
    <button class="btn btn-manual-add" onclick="addNewItemManually()">âœ… Ø¥Ø¶Ø§ÙØ© ÙˆØ­ÙØ¸</button>
    <button class="btn btn-danger" onclick="hideManualAddItem()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div id="productsManagerBox">
    <h3>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>

    <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: flex-end;">
        <button class="btn btn-import" onclick="showImportModal()">ğŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</button>
        <button class="btn btn-danger" onclick="deleteAllProducts()">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
    </div>

    <input type="text" id="productSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø£Ùˆ ÙˆØµÙ Ø§Ù„ØµÙ†Ù..." oninput="filterProductsTable()" />

    <div style="max-height: 400px; overflow-y: auto;">
        <table id="productsTable">
            <thead>
                <tr>
                    <th style="width: 5%;">Ù…</th>
                    <th style="width: 30%;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="width: 40%;">ÙˆØµÙ Ø§Ù„ØµÙ†Ù</th>
                    <th style="width: 15%;">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±.Ø³)</th>
                    <th style="width: 10%;">ØªØ­ÙƒÙ…</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                </tbody>
        </table>
    </div>
    <div style="margin-top:20px; text-align: center;">
        <button class="btn btn-danger" onclick="hideProductsManager()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="companyInfoForm">
  <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</h3>
  
  <input type="file" id="logoFile" accept="image/*" style="display:none" onchange="saveLogo(event)"/> 
  
  <label style="display:block; margin-top:10px; font-weight:bold;">ğŸ–¼ï¸ Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© (Logo):</label>
  <div id="logoPreviewContainer" style="text-align:center; margin-bottom:10px; border:1px solid #eee; padding:10px; border-radius:4px;">
    </div>
  
  <button type="button" class="btn btn-add" style="width:100%; margin-bottom: 15px;" onclick="triggerLogoFileInput()">ğŸ–¼ï¸ Ø±ÙØ¹/ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø±</button>
  
  <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
  <input type="text" id="companyName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©" />
  <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ):</label>
  <input type="text" id="companySubTitle" placeholder="ÙƒÙŠØ§Ù† Ø³Ø¹ÙˆØ¯ÙŠ Ø±Ø§Ø¦Ø¯ ÙˆÙ…ØªØ®ØµØµ ÙÙŠ ØªÙ†ÙÙŠØ° Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„Ø®ÙÙŠÙ ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©" /> 
  <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
  <input type="text" id="companyAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
  <label>Ø§Ù„Ø¬ÙˆØ§Ù„:</label>
  <input type="text" id="companyPhone" placeholder="ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" />
  <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
  <input type="text" id="companyEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
  <div style="margin-top:10px; display:flex; gap:10px;">
    <button class="btn btn-add" style="flex:1;" onclick="saveCompanyInfo()">âœ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button class="btn btn-danger" onclick="hideCompanyInfoForm()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div class="container" id="quoteContainer" style="width: 98%;">
  <div class="header">
    <div class="header-details">
      <h1><span id="headerCompanyName">Ù…Ø¤Ø³Ø³Ø© Ø£Ø­Ø¯Ø« Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</span></h1>
      <p class="company-sub-title" id="headerCompanySubTitle">ÙƒÙŠØ§Ù† Ø³Ø¹ÙˆØ¯ÙŠ Ø±Ø§Ø¦Ø¯ ÙˆÙ…ØªØ®ØµØµ ÙÙŠ ØªÙ†ÙÙŠØ° Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„Ø®ÙÙŠÙ ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</p> 
      <div style="margin-top:10px;">
        <p style="font-size:14px;"><span class="header-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†&#x200f;: </span> <span id="companyAddressDisplay">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</span></p>
        <p style="font-size:14px;"><span class="header-label">Ø§Ù„Ø¬ÙˆØ§Ù„&#x200f;: </span> <span id="companyPhoneDisplay">+966 XX XXX XXXX</span></p>
        <p style="font-size:14px;"><span class="header-label">Ø§Ù„Ø¨Ø±ÙŠØ¯&#x200f;: </span> <span id="companyEmailDisplay">info@ahdath.com</span></p>
      </div>
    </div>
    <div class="logo-box" id="logoBox">
      <div class="logo-placeholder">
        ğŸ¢<br>Ø¶Ø¹ Ø´Ø¹Ø§Ø±Ùƒ Ù‡Ù†Ø§
        <button class="btn btn-add no-print" style="margin-top:5px; font-size:12px; padding:5px 8px;" onclick="triggerLogoFileInput()">Ø±ÙØ¹ Ø´Ø¹Ø§Ø±</button> 
      </div>
    </div>
  </div>

  <div class="content" style="padding: 15px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <p style="font-size:16px; font-weight: bold;">
            Ø¹Ø±Ø¶ Ø£Ø³Ø¹Ø§Ø± Ø±Ù‚Ù…: <span contenteditable="true" id="quoteNumberDisplay">Q-2025-001</span> 
        </p>
        <p style="font-size:16px; font-weight: bold;">
            Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="date"></span>
        </p>
    </div>
    

    <div style="background:#f7f7f7; padding:10px; border-radius:4px; margin-bottom:15px; border: 1px solid #ddd;" class="client-input-box no-print">
      <div style="display:flex; flex-wrap:wrap; gap:10px; position:relative;" class="client-info-container">
        <div style="flex:1; position:relative;">
          <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" id="clientName" class="client-input" oninput="showClientSuggestions(this); updateClientDisplay();" onblur="hideClientSuggestions(this)">
          <div id="clientNameSuggestions" class="autocomplete-list"></div>
        </div>
        
        <input type="text" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" id="clientAddress" class="client-input" style="flex:1;" oninput="updateClientDisplay();">
        <input type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" id="clientPhone" class="client-input" style="flex:1;" oninput="updateClientDisplay();">
      </div>
    </div>
    
    <div style="display:flex; flex-wrap:wrap; gap:15px; width:100%; margin-bottom:15px;" class="client-display">
      <p id="clientNameDisplay" style="flex: 1 1 100%;"></p>
      <p id="clientAddressDisplay" style="flex: 1 1 auto;"></p>
      <p id="clientPhoneDisplay" style="flex: 1 1 auto;"></p>
    </div>

    <table style="width:100%; border-collapse: collapse;">
      <thead>
        <tr style="background:#2d4663; color:#fff;">
          <th style="padding:10px;">Ù…</th>
          <th style="padding:10px;">Ø§Ù„Ø®Ø¯Ù…Ø© &#x200F;/&#x200F; Ø§Ù„Ù…Ù†ØªØ¬</th> 
          <th style="padding:10px;">ÙˆØµÙ Ø§Ù„ØµÙ†Ù</th>
          <th style="padding:10px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th style="padding:10px;" class="no-print cost-column">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</th>
          <th style="padding:10px;">Ø§Ù„Ø³Ø¹Ø±</th>
          <th style="padding:10px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th style="padding:10px;" class="no-print delete-column">Ø­Ø°Ù</th> 
        </tr>
      </thead>
      <tbody id="table"></tbody>
    </table>

    <div class="no-print" style="margin-top: 15px; text-align: right;">
      <button class="btn btn-add" onclick="showAddItem()" style="padding: 10px 20px;">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù…Ø­ÙÙˆØ¸</button>
      <button class="btn btn-manual-add" onclick="showManualAddItem()" style="padding: 10px 20px;">â• ØµÙ†Ù ÙŠØ¯ÙˆÙŠ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div style="margin-top:15px; padding:15px; background:#eff6ff; border-radius:8px; border:2px solid #2d4663;">
      <div class="total-row" style="display: flex;">
        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹&#x200f;:</span><span id="subtotal">0 Ø±.Ø³</span>
      </div>
      <div class="total-row" id="discountRow" style="margin-bottom:8px;"> 
        <span>Ø§Ù„Ø®ØµÙ…&#x200f;:</span>
        <input type="number" id="discount" value="0" min="0" max="100" oninput="saveDiscount(); calc();" style="width:60px; text-align:center;" class="no-print">
        <span class="no-print" style="margin-left:5px;">%</span>
        <span id="discountDisplay" style="font-weight:bold; margin-right:auto;" class="print-only">0%</span>
        <span id="discAmt" style="color:#ef4444; font-weight:bold;">- 0 Ø±.Ø³</span>
      </div>
      <div class="total-row" id="afterDiscRow">
        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…&#x200f;:</span><span id="afterDisc">0 Ø±.Ø³</span>
      </div>
      <div class="total-row" style="display: flex;">
        <span>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (15%)&#x200f;:</span><span id="vat">0 Ø±.Ø³</span>
      </div>
      <div class="total-row" style="font-weight:bold; margin-top:8px; border-top:1px solid #ccc; padding-top:8px; display: flex;">
        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ&#x200f;:</span><span id="total">0 Ø±.Ø³</span>
      </div>
    </div>

    <div style="margin-top:20px; padding:15px; background:#fffbeb; border-radius:8px; border-right:5px solid #f59e0b;">
      <h3> Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h3>
      <textarea id="notesEditor" oninput="updateNotesDisplay()" style="width:100%; min-height:100px; border:1px solid #ccc; padding:10px; border-radius:4px;" class="no-print">
* ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶: 30 ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±
* Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹: 50% Ù…Ù‚Ø¯Ù… Ùˆ 50% Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…
* Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…: ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„ÙŠÙ‡Ø§
* Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©
      </textarea>
      <div id="notesContent" style="white-space: pre-wrap; line-height: 1.6; padding-right: 15px;">
* ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶: 30 ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±
* Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹: 50% Ù…Ù‚Ø¯Ù… Ùˆ 50% Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…
* Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…: ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„ÙŠÙ‡Ø§
* Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©
      </div>
    </div>
  </div>

  <div class="footer" style="background:#2d4663; color:#fff; padding:15px; text-align:center;">
    <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§</p>
    <p><span id="footerEmail">info@ahdath.com</span> | <span id="footerPhone">+966 XX XXX XXXX</span></p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  // ** Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª **
  const PROFIT = 35; 
  const VAT = 15; 
  let selectedProduct = null;
  const LAST_QUOTE_KEY = 'lastQuoteNumber'; 
  const DISCOUNT_KEY = 'currentDiscountPercent'; 

  const DEFAULT_SUB_TITLE = 'ÙƒÙŠØ§Ù† Ø³Ø¹ÙˆØ¯ÙŠ Ø±Ø§Ø¦Ø¯ ÙˆÙ…ØªØ®ØµØµ ÙÙŠ ØªÙ†ÙÙŠØ° Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„Ø®ÙÙŠÙ ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©';
  
  let companyData = {
    name: localStorage.getItem('companyName') || 'Ù…Ø¤Ø³Ø³Ø© Ø£Ø­Ø¯Ø« Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©',
    subTitle: localStorage.getItem('companySubTitle') || DEFAULT_SUB_TITLE, 
    address: localStorage.getItem('companyAddress') || 'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©',
    phone: localStorage.getItem('companyPhone') || '+966 XX XXX XXXX',
    email: localStorage.getItem('companyEmail') || 'info@ahdath.com',
    logo: localStorage.getItem('companyLogo') || null
  };
  
  // ** Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ù…Ø¯Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ø´Ø¹Ø§Ø± **
  function triggerLogoFileInput() {
      document.getElementById('logoFile').click();
  }
  
  // ğŸ› ï¸ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  function saveDiscount() {
      const discountInput = document.getElementById('discount');
      const discountPercent = parseFloat(discountInput.value);
      let discountVal = isNaN(discountPercent) || discountPercent < 0 ? 0 : discountPercent;
      discountVal = Math.min(discountVal, 100);
      localStorage.setItem(DISCOUNT_KEY, discountVal);
  }

  // ğŸ› ï¸ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  function loadDiscount() {
      const savedDiscount = localStorage.getItem(DISCOUNT_KEY);
      if (savedDiscount !== null) {
          document.getElementById('discount').value = savedDiscount;
      }
  }


  // ** Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ **
  function updateCompanyDisplay() {
    document.getElementById('companyAddressDisplay').innerText = companyData.address;
    document.getElementById('companyPhoneDisplay').innerText = companyData.phone;
    document.getElementById('companyEmailDisplay').innerText = companyData.email;
    document.getElementById('headerCompanyName').innerText = companyData.name;
    document.getElementById('headerCompanySubTitle').innerText = companyData.subTitle; 
    document.getElementById('footerEmail').innerText = companyData.email;
    document.getElementById('footerPhone').innerText = companyData.phone;
    
    // ** ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø±Ø£Ø³ **
    const logoBox = document.getElementById('logoBox');
    if (companyData.logo) {
        logoBox.innerHTML = `<img src="${companyData.logo}" style="max-width:100%; max-height:100%;">`;
    } else {
        logoBox.innerHTML = `
          <div class="logo-placeholder">
            ğŸ¢<br>Ø¶Ø¹ Ø´Ø¹Ø§Ø±Ùƒ Ù‡Ù†Ø§
            <button class="btn btn-add no-print" style="margin-top:5px; font-size:12px; padding:5px 8px;" onclick="triggerLogoFileInput()">Ø±ÙØ¹ Ø´Ø¹Ø§Ø±</button>
          </div>
        `;
    }
    
    // ** ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª **
    const logoPreviewContainer = document.getElementById('logoPreviewContainer');
    if (logoPreviewContainer) {
        if (companyData.logo) {
            // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ø­Ø¬Ù… ØµØºÙŠØ± ÙˆÙ…Ø¹ Ø§Ø·Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            logoPreviewContainer.innerHTML = `<img src="${companyData.logo}" style="max-width:100px; max-height:100px; border-radius:4px; border:1px solid #ccc;">`;
        } else {
            logoPreviewContainer.innerHTML = `<p style="color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
        }
    }
  }
  
  // ** Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± (ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†) **
  function saveLogo(e) {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        companyData.logo = ev.target.result;
        localStorage.setItem('companyLogo', companyData.logo);
        updateCompanyDisplay(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„Ù†Ù…ÙˆØ°Ø¬
        // Ù…Ø³Ø­ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        e.target.value = ''; 
      }
      reader.readAsDataURL(file);
    }
  }

  // ** ØªÙ†Ø³ÙŠÙ‚ ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/PDF **
  function updateClientDisplay() {
      const clientName = document.getElementById('clientName').value.trim();
      const clientAddress = document.getElementById('clientAddress').value.trim();
      const clientPhone = document.getElementById('clientPhone').value.trim();
      
      const nameDisplay = document.getElementById('clientNameDisplay');
      const addressDisplay = document.getElementById('clientAddressDisplay');
      const phoneDisplay = document.getElementById('clientPhoneDisplay');

      // 1. Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ - (ØªÙ… Ø¥Ø¶Ø§ÙØ© &#x200f; Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†)
      if (clientName) {
          nameDisplay.innerHTML = `<strong>Ø§Ù„Ø³ÙŠØ¯ &#x200f;:</strong> ${clientName}`; 
          nameDisplay.style.display = 'block'; 
      } else {
          nameDisplay.innerHTML = '';
          nameDisplay.style.display = 'none'; 
      }

      // 2. Ø§Ù„Ø¹Ù†ÙˆØ§Ù† - (ØªÙ… Ø¥Ø¶Ø§ÙØ© &#x200f; Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†)
      if (clientAddress) {
          addressDisplay.innerHTML = `<strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† &#x200f;:</strong> ${clientAddress}`;
          addressDisplay.style.display = 'block';
      } else {
          addressDisplay.innerHTML = '';
          addressDisplay.style.display = 'none';
      }

      // 3. Ø§Ù„Ù‡Ø§ØªÙ - (ØªÙ… Ø¥Ø¶Ø§ÙØ© &#x200f; Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†)
      if (clientPhone) {
          phoneDisplay.innerHTML = `<strong>Ø§Ù„Ù‡Ø§ØªÙ &#x200f;:</strong> ${clientPhone}`;
          phoneDisplay.style.display = 'block';
      } else {
          phoneDisplay.innerHTML = '';
          phoneDisplay.style.display = 'none';
      }
      
      saveClientData();
  }

  const clientInputs = document.querySelectorAll('#clientName, #clientAddress, #clientPhone');
  clientInputs.forEach(input => {
      input.addEventListener('change', () => {
          saveClientData();
      });
  });

  // ** ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ **
  function loadDate() {
    const d = new Date();
    const year = d.getFullYear();
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const day = d.getDate().toString().padStart(2, '0');
    
    document.getElementById('date').textContent = `${year}-${month}-${day}`;
  }
  
  // ** ØªØ³Ù„Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ **
  function loadQuoteNumber() {
    let lastNumber = parseInt(localStorage.getItem(LAST_QUOTE_KEY) || '0');
    const newNumber = lastNumber; 
    const year = new Date().getFullYear();
    const paddedNumber = (newNumber + 1).toString().padStart(3, '0'); 
    const quoteNumber = `Q-${year}-${paddedNumber}`;
    
    const storedQuoteNumber = localStorage.getItem('currentQuoteNumber') || quoteNumber;

    document.getElementById('quoteNumberDisplay').textContent = storedQuoteNumber;
  }
  
  // â­ï¸ Ø¯Ø§Ù„Ø© Ø²ÙŠØ§Ø¯Ø© ØªØ³Ù„Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ (ØªÙØ³ØªØ¯Ø¹Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø­ÙØ¸ PDF)
  function incrementQuoteNumber() {
      // 1. Ù‚Ø±Ø§Ø¡Ø© Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
      const currentQuoteNumberText = document.getElementById('quoteNumberDisplay').textContent.trim();
      
      // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ù‚Ù…ÙŠ
      const numberMatch = currentQuoteNumberText.match(/(\d+)$/);
      
      if (numberMatch) {
          const currentNumber = parseInt(numberMatch[1]);
          
          // 3. Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ±Ù‚Ù… Ø¢Ø®Ø± ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
          localStorage.setItem(LAST_QUOTE_KEY, currentNumber);
      }
      
      // 4. Ù…Ø³Ø­ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
      localStorage.removeItem('currentQuoteNumber'); 

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø°ÙŠ Ø³ÙŠØ²ÙŠØ¯ Ø¨ÙˆØ§Ø­Ø¯)
      loadQuoteNumber(); 
  }


  // Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (ÙˆØ¸ÙŠÙØ© ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ÙƒÙ†Ù‡Ø§ ØªØ¶Ù…Ù† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª)
  document.getElementById('quoteNumberDisplay').addEventListener('blur', function() {
      localStorage.setItem('currentQuoteNumber', this.textContent);
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø£ÙƒØ¨Ø± Ù…Ù† Ø¢Ø®Ø± Ø±Ù‚Ù… Ø¢Ù„ÙŠØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¢Ù„ÙŠ
      const currentNumberMatch = this.textContent.match(/(\d+)$/);
      if (currentNumberMatch) {
          const currentNumber = parseInt(currentNumberMatch[1]);
          const lastNumber = parseInt(localStorage.getItem(LAST_QUOTE_KEY) || '0');
          if (currentNumber > lastNumber) {
              localStorage.setItem(LAST_QUOTE_KEY, currentNumber);
          }
      }
  });


  function updateNotesDisplay() {
    const editor = document.getElementById('notesEditor');
    const display = document.getElementById('notesContent');
    display.innerText = editor.value; 
    localStorage.setItem('quoteNotes', editor.value);
  }
  
  function loadNotes() {
    const savedNotes = localStorage.getItem('quoteNotes');
    const defaultNotes = `* ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶: 30 ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±
* Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹: 50% Ù…Ù‚Ø¯Ù… Ùˆ 50% Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…
* Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…: ÙŠØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„ÙŠÙ‡Ø§
* Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©`;
    const notes = savedNotes || defaultNotes;
    document.getElementById('notesEditor').value = notes;
    document.getElementById('notesContent').innerText = notes;
  }


  // ** Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø­ÙØ¸) **
  
  function getClientList() {
      const clients = localStorage.getItem('clients');
      return clients ? JSON.parse(clients) : [];
  }

  function saveClientData() {
      const name = document.getElementById('clientName').value.trim();
      const address = document.getElementById('clientAddress').value.trim();
      const phone = document.getElementById('clientPhone').value.trim();

      if (name) {
          let clients = getClientList();
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
          clients = clients.filter(c => c.name !== name);
          clients.push({ name, address, phone });
          localStorage.setItem('clients', JSON.stringify(clients));
      }
  }

  function showClientSuggestions(inputElement) {
      const query = inputElement.value.toLowerCase();
      const suggestionsDiv = document.getElementById('clientNameSuggestions');
      suggestionsDiv.innerHTML = '';

      if (!query) {
          suggestionsDiv.style.display = 'none';
          return;
      }
      
      const clients = getClientList();
      const filtered = clients.filter(c => c.name.toLowerCase().includes(query));

      if (filtered.length > 0) {
          filtered.forEach(client => {
              const item = document.createElement('div');
              item.classList.add('autocomplete-item');
              item.innerText = client.name + (client.phone ? ` (${client.phone})` : '');
              item.onmousedown = (e) => { e.preventDefault(); selectClient(client); }; 
              suggestionsDiv.appendChild(item);
          });
          suggestionsDiv.style.display = 'block';
      } else {
          suggestionsDiv.style.display = 'none';
      }
  }
  
  function hideClientSuggestions(inputElement) {
      setTimeout(() => {
          document.getElementById('clientNameSuggestions').style.display = 'none';
      }, 200);
  }
  
  function selectClient(client) {
      document.getElementById('clientName').value = client.name;
      document.getElementById('clientAddress').value = client.address;
      document.getElementById('clientPhone').value = client.phone;
      updateClientDisplay();
      document.getElementById('clientNameSuggestions').style.display = 'none';
  }


  // ** Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) **
  function showClientsManager() {
    document.getElementById('clientSearch').value = ''; 
    loadClientsTable();
    document.getElementById('clientsManagerBox').style.display = 'block';
  }

  function hideClientsManager() {
    document.getElementById('clientsManagerBox').style.display = 'none';
  }

  function loadClientsTable() {
    const tbody = document.getElementById('clientsTableBody');
    tbody.innerHTML = '';
    
    let clients = getClientList(); 

    if (clients.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
        return;
    }

    clients.forEach((c, index) => {
        const row = tbody.insertRow();
        row.dataset.originalName = c.name; 

        row.insertCell().innerText = index + 1;
        
        const nameCell = row.insertCell();
        nameCell.contentEditable = true;
        nameCell.innerText = c.name;
        nameCell.dataset.field = 'name';

        const addressCell = row.insertCell();
        addressCell.contentEditable = true;
        addressCell.innerText = c.address || '';
        addressCell.dataset.field = 'address';
        
        const phoneCell = row.insertCell();
        phoneCell.contentEditable = true;
        phoneCell.innerText = c.phone || '';
        phoneCell.dataset.field = 'phone';

        const controlCell = row.insertCell();
        controlCell.innerHTML = `
            <button onclick="saveClientEdit(this)" class="btn btn-add" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">Ø­ÙØ¸</button>
            <button onclick="deleteClient('${c.name.replace(/'/g, "\\'")}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Ø­Ø°Ù</button>
        `;
    });
  }

  function saveClientEdit(button) {
      const row = button.closest('tr');
      const originalName = row.dataset.originalName;
      
      const newName = row.querySelector('[data-field="name"]').innerText.trim();
      const newAddress = row.querySelector('[data-field="address"]').innerText.trim();
      const newPhone = row.querySelector('[data-field="phone"]').innerText.trim();

      if (!newName) {
          alert('Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„ ØµØ­ÙŠØ­.');
          return;
      }
      
      let clients = getClientList();
      
      clients = clients.filter(c => c.name !== originalName); 
      
      clients.push({ name: newName, address: newAddress, phone: newPhone });
      
      localStorage.setItem('clients', JSON.stringify(clients));
      
      alert('ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
      loadClientsTable(); 
  }

  function deleteClient(nameToDelete) {
      if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„: ${nameToDelete}ØŸ`)) {
          let clients = getClientList();
          clients = clients.filter(c => c.name !== nameToDelete);
          localStorage.setItem('clients', JSON.stringify(clients));
          loadClientsTable();
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
      }
  }

  function filterClientsTable() {
      const input = document.getElementById('clientSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#clientsTableBody tr');

      rows.forEach(row => {
          const name = row.children[1].innerText.toLowerCase();
          const phone = row.children[3].innerText.toLowerCase();
          
          if (name.includes(input) || phone.includes(input)) {
              row.style.display = ''; 
          } else {
              row.style.display = 'none'; 
          }
      });
  }

  function exportClientsToExcel() {
      const clients = getClientList();
      if (clients.length === 0) {
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡Ø§.');
          return;
      }

      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„\tØ§Ù„Ø¹Ù†ÙˆØ§Ù†\tØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„\n";

      clients.forEach(c => {
          const row = `${c.name}\t${c.address || ''}\t${c.phone || ''}`;
          csvContent += row + "\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.xls"); 
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  }
  // ** Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ **


  // ** Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ø¥Ø³ØªÙŠØ±Ø§Ø¯ **
  
  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
  function showImportModal() { 
      document.getElementById('productsManagerBox').style.display = 'none'; 
      document.getElementById('importModalBox').style.display = 'block'; 
  }
  // Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
  function hideImportModal() { 
      document.getElementById('importModalBox').style.display = 'none'; 
      showProductsManager(); 
  }


  function importData() {
    const data = document.getElementById('excelData').value.trim();
    if(!data) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
    const lines = data.split('\n');
    let importedCount = 0;
    lines.forEach(line => {
      const parts = line.split('\t');
      if(parts.length >= 3) {
        const name = parts[0].trim();
        const desc = parts[1].trim();
        const cost = parseFloat(parts[2].trim());
        if(!isNaN(cost) && name) {
          localStorage.setItem(`product_${name}`, JSON.stringify({name, desc, cost}));
          importedCount++;
        }
      }
    });
    alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} ØµÙ†Ù/ØªØµÙ†Ø§Ù. ØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹.`);
    document.getElementById('excelData').value = ''; 
    hideImportModal();
    loadProductsTable(); 
  }
  
  // ** Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ÙŠØ¯ÙˆÙŠ **
  function showManualAddItem() {
    document.getElementById('manualItemBox').style.display='block';
    document.getElementById('manualName').value = '';
    document.getElementById('manualDesc').value = '';
    document.getElementById('manualCost').value = '';
    document.getElementById('manualQty').value = '1';
  }
  
  function hideManualAddItem() {
    document.getElementById('manualItemBox').style.display='none';
  }

  function addNewItemManually() {
    const name = document.getElementById('manualName').value.trim();
    const desc = document.getElementById('manualDesc').value.trim();
    const cost = parseFloat(document.getElementById('manualCost').value);
    const qty = parseInt(document.getElementById('manualQty').value);

    if (!name || isNaN(cost) || cost < 0) {
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµÙ†Ù ÙˆØ³Ø¹Ø± ØªÙƒÙ„ÙØ© ØµØ­ÙŠØ­ÙŠÙ†.');
      return;
    }
    if (isNaN(qty) || qty < 1) {
      alert('Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ ÙˆÙ…ÙˆØ¬Ø¨Ø§Ù‹');
      return;
    }
    
    const newProduct = { name, desc, cost };
    localStorage.setItem(`product_${name}`, JSON.stringify(newProduct));

    addItemToQuote(newProduct, qty);
    
    hideManualAddItem();
  }
  
  // Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ø³ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
  function addItemToQuote(product, qty) {
      const name = product.name;
      const desc = product.desc;
      const cost = product.cost;
      const price = cost + (cost * PROFIT / 100);
      const total = price * qty;
      const tbody = document.getElementById('table');

      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding:8px; text-align:center;">${tbody.children.length + 1}</td>
        <td style="padding:8px;">${name}</td>
        <td style="padding:8px;">${desc}</td>
        <td style="padding:8px; text-align:center;"><input type="number" value="${qty}" min="1" onchange="updateRow(this)" style="width:60px; text-align:center;"></td>
        <td 
            style="padding:8px; text-align:right;" 
            class="no-print cost-column"
            data-cost="${cost.toFixed(2)}"
            dir="ltr">${cost.toFixed(2)}
        </td>
        <td 
            style="padding:8px; text-align:right;"
            contenteditable="true" 
            oninput="updateRowPrice(this)" 
            dir="ltr">${price.toFixed(2)}
        </td> <td style="padding:8px; text-align:right;">${total.toFixed(2)}</td>
        <td style="padding:8px;" class="no-print delete-column"><button onclick="deleteRow(this)" class="btn btn-danger" style="padding:5px 10px; font-size:12px;">Ø­Ø°Ù</button></td>
      `;
      
      row.dataset.cost = cost;
      row.dataset.price = price; // â­ï¸ Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±
      row.dataset.qty = qty;
      
      tbody.appendChild(row);
      calc();
  }

  function filterProducts() {
    const input = document.getElementById('searchItem').value.toLowerCase();
    const suggestionsDiv = document.getElementById('suggestions');
    suggestionsDiv.innerHTML = '';
    
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith('product_')) {
        const p = JSON.parse(localStorage.getItem(key));
        if(p.name && !isNaN(p.cost) && (p.name.toLowerCase().includes(input) || (p.desc && p.desc.toLowerCase().includes(input)))) {
          const div = document.createElement('div');
          div.style.padding='5px'; div.style.cursor='pointer'; div.style.borderBottom='1px dashed #eee';
          div.innerHTML = p.name + ' - ' + (p.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ');
          div.onclick = () => { selectProduct(p); };
          suggestionsDiv.appendChild(div);
        }
      }
    }
  }

  function selectProduct(p) {
    selectedProduct = p;
    document.getElementById('searchItem').value = p.name;
    document.getElementById('suggestions').innerHTML = '';
  }

  function addSelectedItem() {
    if(!selectedProduct) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
    const qty = parseInt(document.getElementById('itemQty').value);
    if(isNaN(qty) || qty < 1) { alert('Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ ÙˆÙ…ÙˆØ¬Ø¨Ø§Ù‹'); return; }
    
    addItemToQuote(selectedProduct, qty);
    hideAddItem();
  }

  function updateRow(input) {
    const row = input.closest('tr');
    let qty = parseInt(input.value);
    if(isNaN(qty) || qty < 1) { qty=1; input.value=1; }
    row.dataset.qty = qty;
    const price = parseFloat(row.dataset.price); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸
    const total = price * qty;
    row.children[6].innerText = total.toFixed(2);
    calc();
  }

  // â­ï¸ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±
  function updateRowPrice(element) {
    const row = element.closest('tr');
    const originalText = element.innerText.trim();
    let newPrice = parseFloat(originalText);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯Ø®Ù„ ØºÙŠØ± Ø±Ù‚Ù…ÙŠ Ø£Ùˆ Ø³Ø§Ù„Ø¨ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙˆÙ†ÙƒØªÙÙŠ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨
    if (isNaN(newPrice) || newPrice < 0) {
        // Ù†Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© (Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ØºÙŠØ± Ø§Ù„ØµØ­ÙŠØ­)
        element.innerText = parseFloat(row.dataset.price).toFixed(2);
        calc(); 
        return;
    }
    
    row.dataset.price = newPrice; // Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    const qty = parseInt(row.dataset.qty);
    const total = newPrice * qty;
    
    row.children[6].innerText = total.toFixed(2); // Ø®Ù„ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    
    // Ù†Ø­Ø¯Ø¯ Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø´ÙƒÙ„ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    const newCost = newPrice / (1 + (PROFIT / 100));
    row.dataset.cost = newCost; 
    row.children[4].innerText = newCost.toFixed(2); // ØªØ­Ø¯ÙŠØ« Ø®Ù„ÙŠØ© Ø§Ù„ØªÙƒÙ„ÙØ© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
    
    calc();
  }

  function deleteRow(btn) {
    btn.closest('tr').remove();
    renumberRows();
    calc();
  }

  function renumberRows() {
    const rows = document.querySelectorAll('#table tr');
    rows.forEach((row, index) => { row.children[0].innerText = index + 1; });
  }
  
  // ğŸ› ï¸ Ø¯Ø§Ù„Ø© calc Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ø¯Ø¹Ù… Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø´Ø±Ø·ÙŠ ÙˆØ¯Ù…Ø¬ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¶
  function calc() {
    const rows = document.querySelectorAll('#table tr');
    let subtotal = 0;
    rows.forEach(r => { 
        const totalCell = r.children[6]; 
        subtotal += parseFloat(totalCell.innerText); 
    });
    document.getElementById('subtotal').innerText = subtotal.toFixed(2) + ' Ø±.Ø³';

    const discountInput = document.getElementById('discount');
    const discountPercent = parseFloat(discountInput.value);

    let discountVal = isNaN(discountPercent) || discountPercent < 0 ? 0 : discountPercent;
    discountVal = Math.min(discountVal, 100);
    discountInput.value = discountVal;

    const discAmount = subtotal * discountVal / 100;
    document.getElementById('discAmt').innerText = '- ' + discAmount.toFixed(2) + ' Ø±.Ø³';
    document.getElementById('discountDisplay').innerText = `${discountVal}%`;

    const afterDisc = subtotal - discAmount;
    document.getElementById('afterDisc').innerText = afterDisc.toFixed(2) + ' Ø±.Ø³';

    const vatAmount = afterDisc * VAT / 100;
    document.getElementById('vat').innerText = vatAmount.toFixed(2) + ' Ø±.Ø³';

    const finalTotal = afterDisc + vatAmount;
    document.getElementById('total').innerText = finalTotal.toFixed(2) + ' Ø±.Ø³';
    
    // ** Ù…Ù†Ø·Ù‚ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± ØµÙ Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ **
    const discountRow = document.getElementById('discountRow');
    const afterDiscRow = document.getElementById('afterDiscRow');

    discountRow.style.display = 'flex';
    afterDiscRow.style.display = 'flex';

    if (window.matchMedia('print').matches && discountVal === 0) {
        discountRow.style.display = 'none';
        afterDiscRow.style.display = 'none';
    }
  }

  function showAddItem() {
    document.getElementById('addItemBox').style.display='block';
    document.getElementById('searchItem').value='';
    document.getElementById('suggestions').innerHTML='';
    selectedProduct=null;
  }
  function hideAddItem() {
    document.getElementById('addItemBox').style.display='none';
  }
  
  // ** Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù **
  function showProductsManager() {
    document.getElementById('productSearch').value = ''; 
    loadProductsTable();
    document.getElementById('productsManagerBox').style.display='block';
  }

  function hideProductsManager() {
    document.getElementById('productsManagerBox').style.display='none';
  }
  
  function loadProductsTable() {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';
    let products = [];
    
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith('product_')) {
        const product = JSON.parse(localStorage.getItem(key));
        product.originalName = product.name; 
        products.push(product);
      }
    }
    
    if (products.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
        return;
    }

    products.forEach((p, index) => {
        const row = tbody.insertRow();
        row.dataset.originalName = p.originalName;

        row.insertCell().innerText = index + 1;
        
        const nameCell = row.insertCell();
        nameCell.contentEditable = true;
        nameCell.innerText = p.name;
        nameCell.dataset.field = 'name';

        const descCell = row.insertCell();
        descCell.contentEditable = true;
        descCell.innerText = p.desc || '';
        descCell.dataset.field = 'desc';
        
        // â­ï¸ Ø¬Ø¹Ù„ Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù
        const costCell = row.insertCell();
        costCell.contentEditable = true;
        costCell.innerText = (p.cost || 0).toFixed(2);
        costCell.dataset.field = 'cost';
        costCell.style.textAlign = 'right';

        const controlCell = row.insertCell();
        controlCell.innerHTML = `
            <button onclick="saveProductEdit(this)" class="btn btn-add" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">Ø­ÙØ¸</button>
            <button onclick="deleteProduct('${p.originalName.replace(/'/g, "\\'")}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Ø­Ø°Ù</button>
        `;
    });
    
    filterProductsTable();
  }
  
  function filterProductsTable() {
    const input = document.getElementById('productSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#productsTableBody tr');

    rows.forEach(row => {
        const name = row.children[1].innerText.toLowerCase();
        const desc = row.children[2].innerText.toLowerCase();
        const cost = row.children[3].innerText.toLowerCase();
        
        if (name.includes(input) || desc.includes(input) || cost.includes(input)) {
            row.style.display = ''; 
        } else {
            row.style.display = 'none'; 
        }
    });
  }

  function saveProductEdit(button) {
      const row = button.closest('tr');
      const originalName = row.dataset.originalName;
      
      const newName = row.querySelector('[data-field="name"]').innerText.trim();
      const newDesc = row.querySelector('[data-field="desc"]').innerText.trim();
      const newCostText = row.querySelector('[data-field="cost"]').innerText.trim();
      const newCost = parseFloat(newCostText);
      
      if (!newName || isNaN(newCost) || newCost < 0) {
          alert('Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµÙ†Ù ÙˆØ³Ø¹Ø± ØªÙƒÙ„ÙØ© ØµØ­ÙŠØ­ÙŠÙ†.');
          return;
      }
      
      if (newName !== originalName) {
          localStorage.removeItem(`product_${originalName}`);
      }
      
      const updatedProduct = {
          name: newName,
          desc: newDesc,
          cost: newCost
      };
      localStorage.setItem(`product_${newName}`, JSON.stringify(updatedProduct));
      
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
      loadProductsTable(); 
  }

  function deleteProduct(nameToDelete) {
      if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙ†Ù: ${nameToDelete}ØŸ`)) {
          localStorage.removeItem(`product_${nameToDelete}`);
          loadProductsTable();
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­.');
      }
  }

  function deleteAllProducts() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
          let count = 0;
          for(let i=localStorage.length - 1; i>=0; i--) {
              const key = localStorage.key(i);
              if(key.startsWith('product_')) {
                  localStorage.removeItem(key);
                  count++;
              }
          }
          loadProductsTable();
          alert(`ØªÙ… Ø­Ø°Ù ${count} ØµÙ†Ù/ØªØµÙ†Ø§Ù Ø¨Ù†Ø¬Ø§Ø­.`);
      }
  }


  // ** Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© **
  function showCompanyInfoForm() {
    updateCompanyDisplay(); 
    
    document.getElementById('companyInfoForm').style.display='block';
    document.getElementById('companyName').value = companyData.name;
    document.getElementById('companySubTitle').value = companyData.subTitle; 
    document.getElementById('companyAddress').value = companyData.address;
    document.getElementById('companyPhone').value = companyData.phone;
    document.getElementById('companyEmail').value = companyData.email;
  }

  function hideCompanyInfoForm() {
    document.getElementById('companyInfoForm').style.display='none';
  }

  function saveCompanyInfo() {
    companyData.name = document.getElementById('companyName').value;
    companyData.subTitle = document.getElementById('companySubTitle').value; 
    companyData.address = document.getElementById('companyAddress').value;
    companyData.phone = document.getElementById('companyPhone').value;
    companyData.email = document.getElementById('companyEmail').value;

    localStorage.setItem('companyName', companyData.name);
    localStorage.setItem('companySubTitle', companyData.subTitle); 
    localStorage.setItem('companyAddress', companyData.address);
    localStorage.setItem('companyPhone', companyData.phone);
    localStorage.setItem('companyEmail', companyData.email);

    updateCompanyDisplay();
    hideCompanyInfoForm();
  }
  
  // ğŸ› ï¸ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙÙˆÙ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/PDF)
  function hideDiscountRows() {
      const discountVal = parseFloat(document.getElementById('discount').value) || 0;
      if (discountVal === 0) {
          document.getElementById('discountRow').style.display = 'none';
          document.getElementById('afterDiscRow').style.display = 'none';
      }
  }

  function showDiscountRows() {
      document.getElementById('discountRow').style.display = 'flex';
      document.getElementById('afterDiscRow').style.display = 'flex';
  }
  
  window.addEventListener('beforeprint', hideDiscountRows);
  window.addEventListener('afterprint', showDiscountRows);

  // â­ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ³Ù„Ø³Ù„
  function printQuote() {
    updateClientDisplay(); 
    calc(); 
    window.print();
    // â­ï¸ Ø²ÙŠØ§Ø¯Ø© ØªØ³Ù„Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶
    incrementQuoteNumber(); 
  }

  // ğŸ› ï¸ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø­Ø°Ù Ù„Ù„Ù€ PDF
  function togglePDFColumns(show) {
      const displayStyle = show ? '' : 'none'; 
      const costColumns = document.querySelectorAll('.cost-column');
      const deleteColumns = document.querySelectorAll('.delete-column');
      const costCells = document.querySelectorAll('.cost-cell');
      const deleteCells = document.querySelectorAll('.delete-cell');
      
      costColumns.forEach(el => { el.style.display = displayStyle; }); 
      deleteColumns.forEach(el => { el.style.display = displayStyle; }); 
      costCells.forEach(el => { el.style.display = displayStyle; }); 
      deleteCells.forEach(el => { el.style.display = displayStyle; }); 
      
      // Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ù„Ø¥Ø¸Ù‡Ø§Ø±
      const nameHeader = document.querySelector('th:nth-child(2)'); 
      const descHeader = document.querySelector('th:nth-child(3)');

      if (!show) {
          nameHeader.style.width = '35%';
          descHeader.style.width = '45%';
      } else {
          nameHeader.style.width = '';
          descHeader.style.width = '';
      }
  }

  // â­ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ PDF Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ³Ù„Ø³Ù„
  function savePDF() {
    updateClientDisplay(); 
    calc(); 

    const element = document.getElementById('quoteContainer');
    const notesEditor = document.getElementById('notesEditor');
    const controls = document.querySelector('.controls'); 
    
    // â­ï¸ ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
    const clientName = document.getElementById('clientName').value.trim();
    const quoteNumber = document.getElementById('quoteNumberDisplay').textContent.trim();
    
    const safeClientName = clientName.replace(/[^a-z0-9\s-]/gi, '_').substring(0, 50) || 'Ø¹Ø±Ø¶_Ø³Ø¹Ø±';
    const filename = `${safeClientName} - ${quoteNumber}.pdf`;
    // â­ï¸ Ù†Ù‡Ø§ÙŠØ© ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù

    // 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
    notesEditor.style.display = 'none'; 
    controls.style.display = 'none';
    hideDiscountRows(); 
    togglePDFColumns(false); 

    const opt = {
      margin: 0,
      filename: filename, // â­ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    html2pdf().set(opt).from(element).save().then(() => {
        // 2. Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
        notesEditor.style.display = 'block'; 
        controls.style.display = 'flex';
        showDiscountRows();
        togglePDFColumns(true); 
        
        // â­ï¸ Ø²ÙŠØ§Ø¯Ø© ØªØ³Ù„Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶
        incrementQuoteNumber(); 
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateCompanyDisplay();
    loadDate(); 
    loadQuoteNumber(); 
    loadNotes();
    loadDiscount(); 
    updateClientDisplay(); 
    calc(); 
  });
</script>
</body>
</html>
